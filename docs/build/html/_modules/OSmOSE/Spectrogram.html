<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSmOSE.Spectrogram &mdash; OSmOSE 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OSmOSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSmOSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">OSmOSE.Spectrogram</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for OSmOSE.Spectrogram</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log10</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">OSmOSE.job</span> <span class="kn">import</span> <span class="n">Job_builder</span>
<span class="kn">from</span> <span class="nn">OSmOSE.cluster</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">reshape</span><span class="p">,</span>
    <span class="n">resample</span><span class="p">,</span>
    <span class="n">compute_stats</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">OSmOSE.Dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">OSmOSE.utils</span> <span class="kn">import</span> <span class="n">safe_read</span><span class="p">,</span> <span class="n">make_path</span><span class="p">,</span> <span class="n">set_umask</span>
<span class="kn">from</span> <span class="nn">OSmOSE.config</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="Spectrogram"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram">[docs]</a><span class="k">class</span> <span class="nc">Spectrogram</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for spectrogram-related computations. Can resample, reshape and normalize audio files before generating spectrograms.</span>

<span class="sd">    The characteristics of the dataset are essential to input for the generation of the spectrograms. There is three ways to input them:</span>
<span class="sd">        - Use the existing `analysis/analysis_sheet.csv` file. If one exist, it will take priority over the other methods. Note that</span>
<span class="sd">        when using this file, some attributes will be locked in read-only mode.</span>
<span class="sd">        - Fill the `analysis_params` argument. More info on the expected value below.</span>
<span class="sd">        - Don&#39;t initialize the attributes in the constructor, and assign their values manually.</span>

<span class="sd">    In any case, all attributes must have a value for the spectrograms to be generated. If it does not exist, `analysis/analysis_sheet.csv`</span>
<span class="sd">    will be written at the end of the `Spectrogram.initialize()` method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_path : `str`</span>
<span class="sd">        The absolute path to the dataset folder. The last folder in the path will be considered as the name of the dataset.</span>
<span class="sd">    sr_analysis : `int`, keyword-only</span>
<span class="sd">        The sample rate used for the generation of the spectrograms.</span>
<span class="sd">    coordinates : `str` or `list` or `tuple`, optional, keyword-only</span>
<span class="sd">        The GPS coordinates of the listening location. If it is of type `str`, it must be the name of a csv file located in `raw/auxiliary`,</span>
<span class="sd">        otherwise a list or a tuple with the first element being the latitude coordinates and second the longitude coordinates.</span>
<span class="sd">    osmose_group_name : `str`, optional, keyword-only</span>
<span class="sd">        The name of the group using the OsmOSE package. All files created using this dataset will be accessible by the osmose group.</span>
<span class="sd">        Will not work on Windows.</span>
<span class="sd">    analysis_params : `dict`, optional, keyword-only</span>
<span class="sd">        If `analysis/analysis_sheet.csv` does not exist, the analysis parameters can be submitted in the form of a dict,</span>
<span class="sd">        with keys matching what is expected:</span>
<span class="sd">            - nfft : `int`</span>
<span class="sd">            - window_size : `int`</span>
<span class="sd">            - overlap : `int`</span>
<span class="sd">            - colormap : `str`</span>
<span class="sd">            - zoom_level : `int`</span>
<span class="sd">            - dynamic_min : `int`</span>
<span class="sd">            - dynamic_max : `int`</span>
<span class="sd">            - number_adjustment_spectrogram : `int`</span>
<span class="sd">            - spectro_duration : `int`</span>
<span class="sd">            - zscore_duration : `float` or `str`</span>
<span class="sd">            - HPfilter_min_freq : `int`</span>
<span class="sd">            - sensitivity_dB : `int`</span>
<span class="sd">            - peak_voltage : `float`</span>
<span class="sd">            - spectro_normalization : `str`</span>
<span class="sd">            - data_normalization : `str`</span>
<span class="sd">            - gain_dB : `int`</span>
<span class="sd">        If additional information is given, it will be ignored. Note that if there is an `analysis/analysis_sheet.csv` file, it will</span>
<span class="sd">        always have the priority.</span>
<span class="sd">    batch_number : `int`, optional, keyword_only</span>
<span class="sd">        The number of batches the dataset files will be split into when submitting parallel jobs (the default is 10).</span>
<span class="sd">    local : `bool`, optional, keyword_only</span>
<span class="sd">        Indicates whether or not the program is run locally. If it is the case, it will not create jobs and will handle the paralelisation</span>
<span class="sd">        alone. The default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">sr_analysis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">gps_coordinates</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">owner_group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">analysis_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span>
            <span class="n">gps_coordinates</span><span class="o">=</span><span class="n">gps_coordinates</span><span class="p">,</span>
            <span class="n">owner_group</span><span class="o">=</span><span class="n">owner_group</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__local</span> <span class="o">=</span> <span class="n">local</span>

        <span class="n">processed_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">)</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">processed_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;adjust_metadata.csv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__analysis_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">analysis_sheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">analysis_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__analysis_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># We put the value in a list so that value[0] returns the right value below.</span>
            <span class="n">analysis_sheet</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">analysis_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">analysis_sheet</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__analysis_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;No valid processed/adjust_metadata.csv found and no parameters provided. All attributes will be initialized to default values..  </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">batch_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">sr_analysis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;nfft&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;nfft&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;window_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;window_size&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;overlap&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;overlap&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;colormap&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;colormap&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span> <span class="k">else</span> <span class="s2">&quot;viridis&quot;</span>

        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;zoom_level&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;zoom_level&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;dynamic_min&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;dynamic_min&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;dynamic_max&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;dynamic_max&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_adjustment_spectrogram</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;number_adjustment_spectrogram&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;number_adjustment_spectrogram&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;spectro_duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">analysis_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;spectro_duration&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;zscore_duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;zscore_duration&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;zscore_duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># fmin cannot be 0 in butterworth. If that is the case, it takes the smallest value possible, epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HPfilter_min_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;HPfilter_min_freq&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;HPfilter_min_freq&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="ow">and</span> <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;HPfilter_min_freq&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;sensitivity_dB&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;sensitivity_dB&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peak_voltage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;peak_voltage&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;peak_voltage&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;spectro_normalization&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;spectro_normalization&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;data_normalization&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;data_normalization&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gain_dB</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;gain_dB&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;gain_dB&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;window_type&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;window_type&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="s2">&quot;hamming&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">analysis_sheet</span><span class="p">[</span><span class="s2">&quot;frequency_resolution&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;frequency_resolution&quot;</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="n">analysis_sheet</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">analysis_sheet</span>
                <span class="k">if</span> <span class="s2">&quot;time_resolution&quot;</span> <span class="ow">in</span> <span class="n">col</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">analysis_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jb</span> <span class="o">=</span> <span class="n">Job_builder</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s2">&quot;agg&quot;</span><span class="p">)</span>

        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>  <span class="c1"># controls default text sizes</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>  <span class="c1"># fontsize of the axes title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>  <span class="c1"># fontsize of the x and y labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;xtick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;ytick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>  <span class="c1"># fontsize of the tick labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>  <span class="c1"># legend fontsize</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>  <span class="c1"># fontsize of the figure title</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__build_path</span><span class="p">(</span><span class="n">dry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># region Spectrogram properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sr_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The sampling frequency of the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sr_analysis</span>

    <span class="nd">@sr_analysis</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sr_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sr_analysis</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nfft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The number of Fast Fourier Transform used to generate the spectrograms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nfft</span>

    <span class="nd">@nfft</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nfft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__nfft</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">window_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The window size of the generated spectrograms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__window_size</span>

    <span class="nd">@window_size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">window_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__window_size</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The overlap percentage between two spectrogram windows.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overlap</span>

    <span class="nd">@overlap</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overlap</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: The type of colormap of the spectrograms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__colormap</span>

    <span class="nd">@colormap</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__colormap</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zoom_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Number of zoom levels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zoom_level</span>

    <span class="nd">@zoom_level</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">zoom_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__zoom_level</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Minimum value of the colormap.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dynamic_min</span>

    <span class="nd">@dynamic_min</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dynamic_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dynamic_min</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Maximum value of the colormap.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dynamic_max</span>

    <span class="nd">@dynamic_max</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dynamic_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dynamic_max</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_adjustment_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Number of spectrograms used to adjust the parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__number_adjustment_spectrogram</span>

    <span class="nd">@number_adjustment_spectrogram</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">number_adjustment_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__number_adjustment_spectrogram</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectro_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Duration of the spectrogram (at the lowest zoom level) in seconds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_duration</span>

    <span class="nd">@spectro_duration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spectro_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_duration</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zscore_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_duration</span>

    <span class="nd">@zscore_duration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">zscore_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_duration</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">HPfilter_min_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;float: Floor frequency for the High Pass Filter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hpfilter_min_freq</span>

    <span class="nd">@HPfilter_min_freq</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">HPfilter_min_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hpfilter_min_freq</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: Numeric sensitivity of the recording device.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sensitivity</span>

    <span class="nd">@sensitivity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Always assume the sensitivity is given in dB.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sensitivity</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">peak_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;float: The maximum voltage of the device.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__peak_voltage</span>

    <span class="nd">@peak_voltage</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">peak_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__peak_voltage</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spectro_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Type of normalization used to generate the spectrograms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_normalization</span>

    <span class="nd">@spectro_normalization</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spectro_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;spectrum&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_normalization</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Type of normalization applied to the data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_normalization</span>

    <span class="nd">@data_normalization</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">,</span> <span class="s2">&quot;zscore&quot;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data_normalization</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gain_dB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;float: Gain of the device in decibels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gain_dB</span>

    <span class="nd">@gain_dB</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">gain_dB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__gain_dB</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">window_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;str: Type of the window used to generate the spectrograms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__window_type</span>

    <span class="nd">@window_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">window_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;hamming&quot;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__window_type</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">frequency_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__frequency_resolution</span>

    <span class="nd">@frequency_resolution</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">frequency_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__frequency_resolution</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time_resolution</span>

    <span class="nd">@time_resolution</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">time_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__time_resolution</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># endregion</span>

    <span class="k">def</span> <span class="nf">__build_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjust</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build some internal paths according to the expected architecture and might create them.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">            adjust : `bool`, optional</span>
<span class="sd">                Whether or not the paths are used to adjust spectrogram parameters.</span>
<span class="sd">            dry: `bool`, optional</span>
<span class="sd">                If set to True, will not create the folders and just return the file path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_umask</span><span class="p">()</span>
        <span class="n">processed_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">)</span>
        <span class="n">audio_foldername</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">raw_audio</span><span class="p">,</span> <span class="n">audio_foldername</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adjust</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_foldername</span> <span class="o">=</span> <span class="s2">&quot;adjustment_spectros&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_foldername</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span> <span class="o">=</span> <span class="n">processed_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">audio_foldername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_foldername</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram_matrix</span> <span class="o">=</span> <span class="n">processed_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">audio_foldername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_foldername</span><span class="p">,</span> <span class="s2">&quot;matrix&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create paths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry</span><span class="p">:</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">statistics</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>

<div class="viewcode-block" id="Spectrogram.check_spectro_size"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.check_spectro_size">[docs]</a>    <span class="k">def</span> <span class="nf">check_spectro_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify if the parameters will generate a spectrogram that can fit one screen properly&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;your nfft is :&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">colored</span><span class="p">(</span>
                    <span class="s2">&quot;PLEASE REDUCE IT UNLESS YOU HAVE A VERY HD SCREEN WITH MORE THAN 1k pixels vertically !!!! &quot;</span><span class="p">,</span>
                    <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">tile_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">tile_duration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">Noverlap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">Nbech</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">Noffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">-</span> <span class="n">Noverlap</span>
        <span class="n">Nbwin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Nbech</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">Noffset</span><span class="p">)</span>
        <span class="n">Freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">)</span>
        <span class="n">Time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nbech</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">,</span> <span class="n">Nbwin</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;your smallest tile has a duration of:&quot;</span><span class="p">,</span> <span class="n">tile_duration</span><span class="p">,</span> <span class="s2">&quot;(s)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Nbwin</span> <span class="o">&gt;</span> <span class="mi">3500</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">colored</span><span class="p">(</span>
                    <span class="s2">&quot;PLEASE REDUCE IT UNLESS YOU HAVE A VERY HD SCREEN WITH MORE THAN 2k pixels horizontally !!!! &quot;</span><span class="p">,</span>
                    <span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;your number of time windows in this tile is:&quot;</span><span class="p">,</span> <span class="n">Nbwin</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;your resolutions : time = &quot;</span><span class="p">,</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s2">&quot;(s) / frequency = &quot;</span><span class="p">,</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">Freq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s2">&quot;(Hz)&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># TODO: some cleaning</span>
<div class="viewcode-block" id="Spectrogram.initialize"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">sr_analysis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reshape_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;legacy&quot;</span><span class="p">,</span> <span class="s2">&quot;classic&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">batch_ind_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">batch_ind_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">pad_silence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">force_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">date_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares everything (path, variables, files) for spectrogram generation. This needs to be run before the spectrograms are generated.</span>
<span class="sd">        If the dataset has not yet been build, it is before the rest of the functions are initialized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sr_analysis : `int`, optional, keyword-only</span>
<span class="sd">            The sampling frequency of the audio files used to generate the spectrograms. If set, will overwrite the Spectrogram.sr_analysis attribute.</span>
<span class="sd">        reshape_method : {&quot;legacy&quot;, &quot;classic&quot;, &quot;none&quot;}, optional, keyword-only</span>
<span class="sd">            Which method to use if the desired size of the spectrogram is different from the audio file duration.</span>
<span class="sd">            - legacy : Legacy method, use bash and sox software to trim the audio files and fill the empty space with nothing.</span>
<span class="sd">            Unpractical when the audio file duration is longer than the desired spectrogram size.</span>
<span class="sd">            - classic : Classic method, use python and sox library to cut and concatenate the audio files to fit the desired duration.</span>
<span class="sd">            Will rewrite the `timestamp.csv` file, thus timestamps may have unexpected behavior if the concatenated files are not chronologically</span>
<span class="sd">            subsequent.</span>
<span class="sd">            - none : Don&#39;t reshape, will throw an error if the file duration is different than the desired spectrogram size. (It is the default behavior)</span>

<span class="sd">        batch_ind_min : `int`, optional, keyword-only</span>
<span class="sd">            The index of the first file to consider. Both this parameter and `batch_ind_max` are not commonly used and are</span>
<span class="sd">            for very specific use cases. Most of the time, you want to initialize the whole dataset (the default is 0).</span>
<span class="sd">        batch_ind_max : `int`, optional, keyword-only</span>
<span class="sd">            The index of the last file to consider (the default is -1, meaning consider every file).</span>
<span class="sd">        pad_silence : `bool`, optional, keyword-only</span>
<span class="sd">            When using the legacy reshaping method, whether there should be a silence padding or not (default is False).</span>
<span class="sd">        force_init : `bool`, optional, keyword-only</span>
<span class="sd">            Force every parameter of the initialization.</span>
<span class="sd">        date_template : `str`, optiona, keyword-only</span>
<span class="sd">            When initializing a spectrogram of a dataset that has not been built, providing a date_template will generate the timestamp.csv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Mandatory init</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_built</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">date_template</span><span class="o">=</span><span class="n">date_template</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unhandled error during dataset building. The spectrogram initialization will be cancelled. The error may be resolved by building the dataset separately first. Description of the error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__build_path</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sr_analysis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span> <span class="o">=</span> <span class="n">sr_analysis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_after_build</span><span class="p">()</span>
        <span class="n">list_wav_withEvent_comp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*wav&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">batch_ind_max</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_ind_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_wav_withEvent_comp</span><span class="p">)</span>
        <span class="n">list_wav_withEvent</span> <span class="o">=</span> <span class="n">list_wav_withEvent_comp</span><span class="p">[</span><span class="n">batch_ind_min</span><span class="p">:</span><span class="n">batch_ind_max</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">audio_file</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">audio_file</span> <span class="ow">in</span> <span class="n">list_wav_withEvent</span>
        <span class="p">]</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;List containing the last job ids to grab outside of the class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Stop initialization if already done</span>
        <span class="n">final_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata.csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">temp_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="s2">&quot;adjust_metadata.csv&quot;</span><span class="p">)</span>
        <span class="n">audio_metadata_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">raw_audio</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata.csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">final_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">temp_path</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
            <span class="ow">and</span> <span class="n">audio_metadata_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">audio_metadata_path</span><span class="o">.</span><span class="n">with_stem</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_init</span>
        <span class="p">):</span>
            <span class="n">audio_file_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">audio_metadata_path</span><span class="p">)[</span><span class="s2">&quot;audio_file_count&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">audio_metadata_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.wav&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="n">audio_file_count</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;It seems these spectrogram parameters are already initialized. If it is an error or you want to rerun the initialization, add the `force_init` argument.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Load variables from raw metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;metadata.csv&quot;</span><span class="p">))</span>
        <span class="n">audio_file_origin_duration</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;audio_file_origin_duration&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sr_origin</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sr_origin&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">audio_file_count</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;audio_file_count&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span> <span class="s2">&quot;subset_files.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span> <span class="s2">&quot;subset_files.csv&quot;</span><span class="p">),</span>
                <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span>

        <span class="c1">#! RESAMPLING</span>
        <span class="n">resample_job_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resample_done</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span> <span class="o">!=</span> <span class="n">sr_origin</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force_init</span><span class="p">):</span>
            <span class="n">resample_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">):</span>
                <span class="n">i_min</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="n">batch_size</span>
                <span class="n">i_max</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">i_min</span> <span class="o">+</span> <span class="n">batch_size</span>
                    <span class="k">if</span> <span class="n">batch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># If it is the last batch, take all files</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local</span><span class="p">:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;input_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="p">,</span>
                            <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="p">,</span>
                            <span class="s2">&quot;target_sr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">,</span>
                            <span class="s2">&quot;batch_ind_min&quot;</span><span class="p">:</span> <span class="n">i_min</span><span class="p">,</span>
                            <span class="s2">&quot;batch_ind_max&quot;</span><span class="p">:</span> <span class="n">i_max</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                    <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">build_job_file</span><span class="p">(</span>
                        <span class="n">script_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">resample</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
                        <span class="n">script_args</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;--input-dir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="si">}</span><span class="s2"> --target-sr </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="si">}</span><span class="s2"> --batch-ind-min </span><span class="si">{</span><span class="n">i_min</span><span class="si">}</span><span class="s2"> --batch-ind-max </span><span class="si">{</span><span class="n">i_max</span><span class="si">}</span><span class="s2"> --output-dir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;OSmOSE_resample&quot;</span><span class="p">,</span>
                        <span class="n">preset</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span>
                        <span class="n">logdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># TODO: use importlib.resources</span>

                    <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">submit_job</span><span class="p">()</span>
                    <span class="n">resample_job_id_list</span> <span class="o">+=</span> <span class="n">job_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="n">resample_job_id_list</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1">#! ZSCORE NORMALIZATION</span>
        <span class="n">norma_job_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="c1">#os.listdir(self.path.joinpath(OSMOSE_PATH.statistics))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span> <span class="o">==</span> <span class="s2">&quot;zscore&quot;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">):</span>
                <span class="n">i_min</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="n">batch_size</span>
                <span class="n">i_max</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">i_min</span> <span class="o">+</span> <span class="n">batch_size</span>
                    <span class="k">if</span> <span class="n">batch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># If it is the last batch, take all files</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local</span><span class="p">:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="n">compute_stats</span><span class="p">,</span>
                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;input_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="p">,</span>
                            <span class="s2">&quot;output_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                                <span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">statistics</span><span class="p">,</span>
                                <span class="s2">&quot;SummaryStats_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_min</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;target_sr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">,</span>
                            <span class="s2">&quot;batch_ind_min&quot;</span><span class="p">:</span> <span class="n">i_min</span><span class="p">,</span>
                            <span class="s2">&quot;batch_ind_max&quot;</span><span class="p">:</span> <span class="n">i_max</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                    <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jobfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">build_job_file</span><span class="p">(</span>
                        <span class="n">script_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">compute_stats</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
                        <span class="n">script_args</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;--input-dir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="si">}</span><span class="s2"> --hpfilter-min-freq </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">HPfilter_min_freq</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                    --batch-ind-min </span><span class="si">{</span><span class="n">i_min</span><span class="si">}</span><span class="s2"> --batch-ind-max </span><span class="si">{</span><span class="n">i_max</span><span class="si">}</span><span class="s2"> --output-file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">statistics</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SummaryStats_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">i_min</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;OSmOSE_get_zscore_params&quot;</span><span class="p">,</span>
                        <span class="n">preset</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span>
                        <span class="n">logdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">dependency</span><span class="o">=</span><span class="n">resample_job_id_list</span><span class="p">)</span>
                    <span class="n">norma_job_id_list</span> <span class="o">+=</span> <span class="n">job_id</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="n">norma_job_id_list</span>

            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1">#! RESHAPING</span>
        <span class="c1"># Reshape audio files to fit the maximum spectrogram size, whether it is greater or smaller.</span>
        <span class="n">reshape_job_id_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">audio_file_origin_duration</span><span class="p">):</span>
            <span class="c1"># We might reshape the files and create the folder. Note: reshape function might be memory-heavy and deserve a proper qsub job.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">audio_file_origin_duration</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">reshape_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;legacy&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Spectrogram size cannot be greater than file duration. If you want to automatically reshape your audio files to fit the spectrogram size, consider setting the reshape method to &#39;reshape&#39;.&quot;</span>
                <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Automatically reshaping audio files to fit the spectro duration value. Files will be </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="si">}</span><span class="s2"> seconds long.&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">reshape_method</span> <span class="o">==</span> <span class="s2">&quot;classic&quot;</span><span class="p">:</span>
                <span class="c1"># build job, qsub, stuff</span>

                <span class="n">input_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span> <span class="k">if</span> <span class="n">resample_done</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span>

                <span class="n">nb_reshaped_files</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">audio_file_origin_duration</span> <span class="o">*</span> <span class="n">audio_file_count</span>
                <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;audio_file_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_reshaped_files</span>
                <span class="n">next_offset_beginning</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">offset_end</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">i_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i_max</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">offset_beginning</span> <span class="o">=</span> <span class="n">next_offset_beginning</span>
                    <span class="n">next_offset_beginning</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">i_min</span> <span class="o">=</span> <span class="n">i_max</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">offset_beginning</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">i_max</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">i_min</span> <span class="o">+</span> <span class="n">batch_size</span>
                        <span class="k">if</span> <span class="n">batch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">i_min</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span>
                        <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># If it is the last batch, take all files</span>

                    <span class="k">while</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">i_max</span> <span class="o">-</span> <span class="n">i_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">audio_file_origin_duration</span>
                            <span class="o">-</span> <span class="n">offset_end</span>
                            <span class="o">-</span> <span class="n">offset_beginning</span>  <span class="c1"># Determines if the offset would require more than one file</span>
                        <span class="p">)</span>
                        <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span>
                        <span class="o">&gt;</span> <span class="n">audio_file_origin_duration</span>
                        <span class="ow">and</span> <span class="n">i_max</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span>
                    <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">i_max</span> <span class="o">-</span> <span class="n">i_min</span> <span class="o">+</span> <span class="n">offset_end</span> <span class="o">-</span> <span class="n">offset_beginning</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">audio_file_origin_duration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">:</span>
                        <span class="n">i_max</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">last_file_behavior</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;pad&quot;</span>
                        <span class="k">if</span> <span class="n">batch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="ow">or</span> <span class="n">i_max</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="s2">&quot;discard&quot;</span>
                    <span class="p">)</span>

                    <span class="n">offset_end</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">i_max</span> <span class="o">-</span> <span class="n">i_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">audio_file_origin_duration</span>
                        <span class="o">-</span> <span class="n">offset_beginning</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span>
                    <span class="k">if</span> <span class="n">offset_end</span><span class="p">:</span>
                        <span class="n">next_offset_beginning</span> <span class="o">=</span> <span class="n">audio_file_origin_duration</span> <span class="o">-</span> <span class="n">offset_end</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">offset_end</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ? ack</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local</span><span class="p">:</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">=</span><span class="n">reshape</span><span class="p">,</span>
                            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;input_files&quot;</span><span class="p">:</span> <span class="n">input_files</span><span class="p">,</span>
                                <span class="s2">&quot;chunk_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">,</span>
                                <span class="s2">&quot;output_dir_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="p">,</span>
                                <span class="s2">&quot;offset_beginning&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_beginning</span><span class="p">),</span>
                                <span class="s2">&quot;offset_end&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_end</span><span class="p">),</span>
                                <span class="s2">&quot;batch_ind_min&quot;</span><span class="p">:</span> <span class="n">i_min</span><span class="p">,</span>
                                <span class="s2">&quot;batch_ind_max&quot;</span><span class="p">:</span> <span class="n">i_max</span><span class="p">,</span>
                                <span class="s2">&quot;last_file_behavior&quot;</span><span class="p">:</span> <span class="n">last_file_behavior</span><span class="p">,</span>
                                <span class="s2">&quot;timestamp_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">)</span>
                            <span class="p">},</span>
                        <span class="p">)</span>

                        <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">build_job_file</span><span class="p">(</span>
                            <span class="n">script_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">reshape</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
                            <span class="n">script_args</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;--input-files </span><span class="si">{</span><span class="n">input_files</span><span class="si">}</span><span class="s2"> --chunk-size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="si">}</span><span class="s2"> --batch-ind-min </span><span class="si">{</span><span class="n">i_min</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                                        --batch-ind-max </span><span class="si">{</span><span class="n">i_max</span><span class="si">}</span><span class="s2"> --output-dir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="si">}</span><span class="s2"> --timestamp-path </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;timestamp.csv&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                                        --offset-beginning </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">offset_beginning</span><span class="p">)</span><span class="si">}</span><span class="s2"> --offset-end </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">offset_end</span><span class="p">)</span><span class="si">}</span><span class="se">\</span>
<span class="s2">                                        --last-file-behavior </span><span class="si">{</span><span class="n">last_file_behavior</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;--force&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">force_init</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;--overwrite&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">resample_done</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;OSmOSE_reshape_py&quot;</span><span class="p">,</span>
                            <span class="n">preset</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span>
                            <span class="n">logdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">dependency</span><span class="o">=</span><span class="n">norma_job_id_list</span> <span class="k">if</span> <span class="n">norma_job_id_list</span> <span class="k">else</span> <span class="n">resample_job_id_list</span><span class="p">)</span>
                        <span class="n">reshape_job_id_list</span> <span class="o">+=</span> <span class="n">job_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="n">reshape_job_id_list</span>

                <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">reshape_method</span> <span class="o">==</span> <span class="s2">&quot;legacy&quot;</span><span class="p">:</span>
                <span class="n">silence_arg</span> <span class="o">=</span> <span class="s2">&quot;-s&quot;</span> <span class="k">if</span> <span class="n">pad_silence</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">):</span>
                    <span class="n">i_min</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="n">batch_size</span>
                    <span class="n">i_max</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">i_min</span> <span class="o">+</span> <span class="n">batch_size</span>
                        <span class="k">if</span> <span class="n">batch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span>
                    <span class="p">)</span>  <span class="c1"># If it is the last batch, take all files</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">build_job_file</span><span class="p">(</span>
                        <span class="n">script_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;reshaper.sh&quot;</span><span class="p">),</span>
                        <span class="n">script_args</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-d </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> -i </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -t </span><span class="si">{</span><span class="n">sr_analysis</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                    -m </span><span class="si">{</span><span class="n">i_min</span><span class="si">}</span><span class="s2"> -x </span><span class="si">{</span><span class="n">i_max</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="si">}</span><span class="s2"> -n </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">silence_arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;OSmOSE_reshape_bash&quot;</span><span class="p">,</span>
                        <span class="n">preset</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span>
                        <span class="n">logdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jb</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">dependency</span><span class="o">=</span><span class="n">resample_job_id_list</span><span class="p">)</span>
                    <span class="n">reshape_job_id_list</span> <span class="o">+=</span> <span class="n">job_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="n">reshape_job_id_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">):</span>
                <span class="c1"># The timestamp.csv is recreated by the reshaping step. We only need to copy it if we don&#39;t reshape.</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_input_audio_file</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">))</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dataset_fileDuration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span>
        <span class="n">new_meta_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;metadata.csv&quot;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">new_meta_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">new_meta_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;sr_analysis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">,</span>
            <span class="s2">&quot;nfft&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span>
            <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span>
            <span class="s2">&quot;overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
            <span class="s2">&quot;colormap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">,</span>
            <span class="s2">&quot;zoom_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="p">,</span>
            <span class="s2">&quot;number_adjustment_spectrogram&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_adjustment_spectrogram</span><span class="p">,</span>
            <span class="s2">&quot;dynamic_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_min</span><span class="p">,</span>
            <span class="s2">&quot;dynamic_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_max</span><span class="p">,</span>
            <span class="s2">&quot;spectro_duration&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">,</span>
            <span class="s2">&quot;audio_file_folder_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;data_normalization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span><span class="p">,</span>
            <span class="s2">&quot;HPfilter_min_freq&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">HPfilter_min_freq</span><span class="p">,</span>
            <span class="s2">&quot;sensitivity_dB&quot;</span><span class="p">:</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">),</span>
            <span class="s2">&quot;peak_voltage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_voltage</span><span class="p">,</span>
            <span class="s2">&quot;spectro_normalization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span><span class="p">,</span>
            <span class="s2">&quot;gain_dB&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain_dB</span><span class="p">,</span>
            <span class="s2">&quot;zscore_duration&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span><span class="p">,</span>
            <span class="s2">&quot;window_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_type</span><span class="p">,</span>
            <span class="s2">&quot;frequency_resolution&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_resolution</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;time_resolution_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">time_res</span><span class="p">})</span>

        <span class="n">analysis_sheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>

        <span class="n">adjust_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="s2">&quot;adjust_metadata.csv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adjust_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">adjust_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span> <span class="c1"># Always overwrite this file</span>

        <span class="n">analysis_sheet</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">adjust_path</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">adjust_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adjust_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Failed to write adjust_metadata.csv&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrogram.audio_file_list_csv"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.audio_file_list_csv">[docs]</a>    <span class="k">def</span> <span class="nf">audio_file_list_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">list_audio</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.wav&quot;</span><span class="p">))</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wav_list_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">list_audio</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">csv_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">csv_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="k">for</span> <span class="n">audio</span> <span class="ow">in</span> <span class="n">list_audio</span><span class="p">]))</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">csv_path</span></div>

<div class="viewcode-block" id="Spectrogram.update_parameters"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.update_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the csv file filename and compare it to the spectrogram parameters. If any parameter is different, the file will be replaced and the fields changed.</span>
<span class="sd">        </span>
<span class="sd">        If there is nothing to update, the file won&#39;t be changed.</span>
<span class="sd">        </span>
<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        filename: Path</span>
<span class="sd">            The path to the csv file to be updated.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            True if the parameters were updated else False.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The file must be a .csv file to be updated.&quot;</span><span class="p">)</span>
        <span class="n">new_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;sr_analysis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">,</span>
            <span class="s2">&quot;nfft&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span>
            <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span>
            <span class="s2">&quot;overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
            <span class="s2">&quot;colormap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">,</span>
            <span class="s2">&quot;zoom_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="p">,</span>
            <span class="s2">&quot;number_adjustment_spectrogram&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_adjustment_spectrogram</span><span class="p">,</span>
            <span class="s2">&quot;dynamic_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_min</span><span class="p">,</span>
            <span class="s2">&quot;dynamic_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_max</span><span class="p">,</span>
            <span class="s2">&quot;spectro_duration&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">,</span>
            <span class="s2">&quot;audio_file_folder_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;data_normalization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span><span class="p">,</span>
            <span class="s2">&quot;HPfilter_min_freq&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">HPfilter_min_freq</span><span class="p">,</span>
            <span class="s2">&quot;sensitivity_dB&quot;</span><span class="p">:</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">),</span>
            <span class="s2">&quot;peak_voltage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_voltage</span><span class="p">,</span>
            <span class="s2">&quot;spectro_normalization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span><span class="p">,</span>
            <span class="s2">&quot;gain_dB&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain_dB</span><span class="p">,</span>
            <span class="s2">&quot;zscore_duration&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span><span class="p">,</span>
            <span class="s2">&quot;window_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_type</span><span class="p">,</span>
            <span class="s2">&quot;frequency_resolution&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_resolution</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_resolution</span><span class="p">):</span>
            <span class="n">new_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;time_resolution_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">time_res</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">new_params</span><span class="p">])</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="n">orig_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">orig_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="ow">or</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_params</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">new_params</span><span class="p">]):</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">new_params</span><span class="p">])</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Spectrogram.to_csv"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Outputs the characteristics of the spectrogram the specified file in csv format.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        filename: Path</span>
<span class="sd">            The path of the file to be written.&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spectro_foldername</span><span class="p">,</span>
            <span class="s2">&quot;nfft&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span>
            <span class="s2">&quot;window_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span>
            <span class="s2">&quot;overlap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;zoom_level&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="c1"># &quot;dynamic_min&quot;: self.dynamic_min,</span>
            <span class="c1"># &quot;dynamic_max&quot;: self.dynamic_max,</span>
            <span class="c1"># &quot;number_adjustment_spectrogram&quot;: self.number_adjustment_spectrogram,</span>
            <span class="c1"># &quot;spectro_duration&quot;: self.spectro_duration,</span>
            <span class="c1"># &quot;zscore_duration&quot;: self.zscore_duration,</span>
            <span class="c1"># &quot;HPfilter_min_freq&quot;: self.HPfilter_min_freq,</span>
            <span class="c1"># &quot;sensitivity_dB&quot;: 20 * log10(self.sensitivity / 1e6),</span>
            <span class="c1"># &quot;peak_voltage&quot;: self.peak_voltage,</span>
            <span class="c1"># &quot;spectro_normalization&quot;: self.spectro_normalization,</span>
            <span class="c1"># &quot;data_normalization&quot;: self.data_normalization,</span>
            <span class="c1"># &quot;gain_dB&quot;: self.gain_dB</span>
        <span class="p">}</span>
        <span class="c1"># TODO: readd `, &#39;cvr_max&#39;:self.dynamic_max, &#39;cvr_min&#39;:self.dynamic_min` above when ok with Aplose</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span></div>

    <span class="c1"># region On cluster</span>

<div class="viewcode-block" id="Spectrogram.process_file"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.process_file">[docs]</a>    <span class="k">def</span> <span class="nf">process_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">audio_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">adjust</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_matrix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">clean_adjust_folder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read an audio file and generate the associated spectrogram.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        audio_file : `str` or `Path`</span>
<span class="sd">            The name of the audio file to be processed</span>
<span class="sd">        adjust : `bool`, optional, keyword-only</span>
<span class="sd">            Indicates whether the file should be processed alone to adjust the spectrogram parameters (the default is False)</span>
<span class="sd">        save_matrix : `bool`, optional, keyword-only</span>
<span class="sd">            Whether to save the spectrogram matrices or not. Note that activating this parameter might increase greatly the volume of the project. (the default is False)</span>
<span class="sd">        clean_adjust_folder: `bool`, optional, keyword-only</span>
<span class="sd">            Whether the adjustment folder should be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_umask</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clean_adjust_folder</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="s2">&quot;adjustment_spectros&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                        <span class="s2">&quot;adjustment_spectros&quot;</span>
                    <span class="p">),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__build_path</span><span class="p">(</span><span class="n">adjust</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_matrix</span> <span class="o">=</span> <span class="n">save_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust</span> <span class="o">=</span> <span class="n">adjust</span>
        <span class="n">Zscore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">adjust</span> <span class="k">else</span> <span class="s2">&quot;original&quot;</span>

        <span class="n">audio_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">save_matrix</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram_matrix</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span>
            <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The spectrograms for the file </span><span class="si">{</span><span class="n">audio_file</span><span class="si">}</span><span class="s2"> have already been generated, skipping...&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1">#! Determination of zscore normalization parameters</span>
        <span class="k">if</span> <span class="n">Zscore</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span> <span class="o">==</span> <span class="s2">&quot;zscore&quot;</span> <span class="ow">and</span> <span class="n">Zscore</span> <span class="o">!=</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="n">average_over_H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">Zscore</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;summaryStats*&quot;</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span>

            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean_avg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">average_over_H</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;std_avg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">average_over_H</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__summStats</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">audio_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">audio_file</span><span class="si">}</span><span class="s2"> must be in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="si">}</span><span class="s2"> in order to be processed.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">Zscore</span> <span class="ow">and</span> <span class="n">Zscore</span> <span class="o">!=</span> <span class="s2">&quot;original&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span> <span class="o">==</span> <span class="s2">&quot;zscore&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__summStats</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__summStats</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">audio_file</span>
            <span class="p">][</span><span class="s2">&quot;mean_avg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__summStats</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__summStats</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">audio_file</span>
            <span class="p">][</span><span class="s2">&quot;std_avg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#! File processing</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">safe_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">audio_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span> <span class="o">==</span> <span class="s2">&quot;instrument&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_voltage</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span>
                <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gain_dB</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">bpcoef</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span>
            <span class="mi">20</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">HPfilter_min_freq</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;sos&quot;</span><span class="p">,</span>
            <span class="n">btype</span><span class="o">=</span><span class="s2">&quot;bandpass&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">sosfilt</span><span class="p">(</span><span class="n">bpcoef</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adjust</span><span class="p">:</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gen_tiles</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spectrogram.gen_tiles"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.gen_tiles">[docs]</a>    <span class="k">def</span> <span class="nf">gen_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate spectrogram tiles corresponding to the zoom levels.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : `np.ndarray`</span>
<span class="sd">            The audio data from which the tiles will be generated.</span>
<span class="sd">        sample_rate : `int`</span>
<span class="sd">            The sample rate of the audio data.</span>
<span class="sd">        output_file : `str`</span>
<span class="sd">            The name of the output spectrogram.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_normalization</span> <span class="o">==</span> <span class="s2">&quot;zscore&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span> <span class="o">!=</span> <span class="s2">&quot;original&quot;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__zscore_std</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">zscore_duration</span> <span class="o">==</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>

        <span class="n">nber_tiles_lowest_zoom_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span><span class="p">)</span>
        <span class="n">tile_duration</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="n">nber_tiles_lowest_zoom_level</span>

        <span class="n">Sxx_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nber_tiles_lowest_zoom_level</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">tile</span> <span class="o">*</span> <span class="n">tile_duration</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">tile_duration</span>

            <span class="n">sample_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)]</span>

            <span class="n">Sxx</span><span class="p">,</span> <span class="n">Freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_spectro</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">sample_data</span><span class="p">,</span>
                <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nber_tiles_lowest_zoom_level</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">Sxx_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Sxx_2</span><span class="p">,</span> <span class="n">Sxx</span><span class="p">))</span>

        <span class="n">Sxx_lowest_level</span> <span class="o">=</span> <span class="n">Sxx_2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="n">segment_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">Sxx_lowest_level</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># loop over the zoom levels from the second lowest to the highest one</span>
        <span class="k">for</span> <span class="n">zoom_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">nberspec</span> <span class="o">=</span> <span class="n">Sxx_lowest_level</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">zoom_level</span><span class="p">)</span>

            <span class="c1"># loop over the tiles at each zoom level</span>
            <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">zoom_level</span><span class="p">):</span>
                <span class="n">Sxx_int</span> <span class="o">=</span> <span class="n">Sxx_lowest_level</span><span class="p">[:,</span> <span class="n">tile</span> <span class="o">*</span> <span class="n">nberspec</span> <span class="p">:</span> <span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nberspec</span><span class="p">][</span>
                    <span class="p">:,</span> <span class="p">::</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span> <span class="o">-</span> <span class="n">zoom_level</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="n">segment_times_int</span> <span class="o">=</span> <span class="n">segment_times</span><span class="p">[</span>
                    <span class="p">:,</span> <span class="n">tile</span> <span class="o">*</span> <span class="n">nberspec</span> <span class="p">:</span> <span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nberspec</span>
                <span class="p">][:,</span> <span class="p">::</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_level</span> <span class="o">-</span> <span class="n">zoom_level</span><span class="p">)]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
                    <span class="n">log_spectro</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Sxx_int</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span>
                    <span class="n">log_spectro</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Sxx_int</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">generate_and_save_figures</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">segment_times_int</span><span class="p">,</span>
                    <span class="n">freq</span><span class="o">=</span><span class="n">Freq</span><span class="p">,</span>
                    <span class="n">log_spectro</span><span class="o">=</span><span class="n">log_spectro</span><span class="p">,</span>
                    <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">zoom_level</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Spectrogram.gen_spectro"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.gen_spectro">[docs]</a>    <span class="k">def</span> <span class="nf">gen_spectro</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="n">Path</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the spectrograms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : `np.ndarray`</span>
<span class="sd">            The audio data from which the tiles will be generated.</span>
<span class="sd">        sample_rate : `int`</span>
<span class="sd">            The sample rate of the audio data.</span>
<span class="sd">        output_file : `str`</span>
<span class="sd">            The name of the output spectrogram.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Sxx : `np.NDArray[float64]`</span>
<span class="sd">        Freq : `np.NDArray[float]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Noverlap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
                <span class="n">scale_psd</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span>
                <span class="n">scale_psd</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sample_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
                <span class="n">scale_psd</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(((</span><span class="n">win</span> <span class="o">*</span> <span class="n">win</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span>
                <span class="n">scale_psd</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">win</span> <span class="o">*</span> <span class="n">win</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="n">Nbech</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">Noffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">-</span> <span class="n">Noverlap</span>
        <span class="n">Nbwin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Nbech</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">Noffset</span><span class="p">)</span>
        <span class="n">Freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">)</span>

        <span class="n">Sxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">Freq</span><span class="p">),</span> <span class="n">Nbwin</span><span class="p">])</span>
        <span class="n">Time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nbech</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">Nbwin</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idwin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbwin</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">):</span>
                <span class="n">x_win</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idwin</span> <span class="o">*</span> <span class="n">Noffset</span> <span class="p">:</span> <span class="n">idwin</span> <span class="o">*</span> <span class="n">Noffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">Sxx</span><span class="p">[:,</span> <span class="n">idwin</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span>
                    <span class="n">x_win</span><span class="p">,</span>
                    <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                    <span class="n">window</span><span class="o">=</span><span class="s2">&quot;hamming&quot;</span><span class="p">,</span>
                    <span class="n">nperseg</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">),</span>
                    <span class="n">noverlap</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">scaling</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_win</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idwin</span> <span class="o">*</span> <span class="n">Noffset</span> <span class="p">:</span> <span class="n">idwin</span> <span class="o">*</span> <span class="n">Noffset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">]</span> <span class="o">*</span> <span class="n">win</span>
                <span class="n">Sxx</span><span class="p">[:,</span> <span class="n">idwin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">x_win</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">Sxx</span><span class="p">[:,</span> <span class="n">idwin</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_psd</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
            <span class="n">log_spectro</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">Sxx</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1e-20</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectro_normalization</span> <span class="o">==</span> <span class="s2">&quot;spectrum&quot;</span><span class="p">:</span>
            <span class="n">log_spectro</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Sxx</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1e-20</span><span class="p">))</span>
            
        <span class="c1"># save spectrogram matrices (intensity, time and freq) in a npz file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_matrix</span><span class="p">:</span>
            <span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>

            <span class="n">output_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_output_spectrogram_matrix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="n">output_file</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">)</span>

            <span class="c1"># TODO: add an option to force regeneration (in case of corrupted file)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_matrix</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
                    <span class="n">output_matrix</span><span class="p">,</span>
                    <span class="n">Sxx</span><span class="o">=</span><span class="n">Sxx</span><span class="p">,</span>
                    <span class="n">log_spectro</span><span class="o">=</span><span class="n">log_spectro</span><span class="p">,</span>
                    <span class="n">Freq</span><span class="o">=</span><span class="n">Freq</span><span class="p">,</span>
                    <span class="n">Time</span><span class="o">=</span><span class="n">Time</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">output_matrix</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Sxx</span><span class="p">,</span> <span class="n">Freq</span></div>

<div class="viewcode-block" id="Spectrogram.generate_and_save_figures"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.generate_and_save_figures">[docs]</a>    <span class="k">def</span> <span class="nf">generate_and_save_figures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">freq</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">log_spectro</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">output_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the spectrogram figures to the output file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : `np.NDArray[floating]`</span>
<span class="sd">        freq : `np.NDArray[floating]`</span>
<span class="sd">        log_spectro : `np.NDArray[signed int]`</span>
<span class="sd">        output_file : `str`</span>
<span class="sd">            The name of the spectrogram file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="k">return</span>
        <span class="c1"># Plotting spectrogram</span>
        <span class="n">my_dpi</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">fact_x</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="n">fact_y</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fact_x</span> <span class="o">*</span> <span class="mi">1800</span> <span class="o">/</span> <span class="n">my_dpi</span><span class="p">,</span> <span class="n">fact_y</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">/</span> <span class="n">my_dpi</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">my_dpi</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">)</span>  <span class="c1"># .reversed()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_spectro</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_map</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_max</span><span class="p">)</span>
        <span class="c1"># plt.colorbar()</span>

        <span class="c1"># If generate all</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For test</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

        <span class="c1"># Saving spectrogram plot to file</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

        <span class="n">metadata_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span> <span class="s2">&quot;adjust_metadata.csv&quot;</span>
        <span class="p">)</span>

        <span class="n">metadata_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="n">OSMOSE_PATH</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectro_duration</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sr_analysis</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata.csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata_output</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">metadata_input</span><span class="p">,</span> <span class="n">metadata_output</span><span class="p">)</span></div>
        <span class="c1"># try:</span>
        <span class="c1">#     if not self.adjust and metadata_input.exists() and not metadata_output.exists():</span>
        <span class="c1">#         metadata_input.rename(metadata_output)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pass</span>

    <span class="c1"># endregion</span>

<div class="viewcode-block" id="Spectrogram.process_all_files"><a class="viewcode-back" href="../../autoapi/OSmOSE/index.html#OSmOSE.Spectrogram.Spectrogram.process_all_files">[docs]</a>    <span class="k">def</span> <span class="nf">process_all_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">save_matrix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process all the files in the dataset and generates the spectrograms. It uses the python multiprocessing library</span>
<span class="sd">        to parallelise the computation, so it is less efficient to use this method rather than the job scheduler if run on a cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;save_matrix&quot;</span><span class="p">:</span> <span class="n">save_matrix</span><span class="p">}</span>

        <span class="n">map_process_file</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_number</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_process_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_wav_to_process</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Rumengol.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>