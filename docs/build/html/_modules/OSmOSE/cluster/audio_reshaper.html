<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSmOSE.cluster.audio_reshaper &mdash; OSmOSE 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            OSmOSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OSmOSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">OSmOSE.cluster.audio_reshaper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for OSmOSE.cluster.audio_reshaper</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span>

<span class="kn">import</span> <span class="nn">soundfile</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">OSmOSE.utils</span> <span class="kn">import</span> <span class="n">make_path</span><span class="p">,</span> <span class="n">set_umask</span>
<span class="kn">from</span> <span class="nn">OSmOSE.config</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="substract_timestamps"><a class="viewcode-back" href="../../../autoapi/OSmOSE/cluster/audio_reshaper/index.html#OSmOSE.cluster.audio_reshaper.substract_timestamps">[docs]</a><span class="k">def</span> <span class="nf">substract_timestamps</span><span class="p">(</span>
    <span class="n">input_timestamp</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Substracts two timestamp_list from the &quot;timestamp&quot; column of a dataframe at the indexes of files[i] and files[i-1] and returns the time delta between them</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">        input_timestamp: the pandas DataFrame containing at least two columns: filename and timestamp</span>

<span class="sd">        files: the list of file names corresponding to the filename column of the dataframe</span>

<span class="sd">        index: the index of the file whose timestamp will be substracted</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        The time between the two timestamp_list as a datetime.timedelta object&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">cur_timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">input_timestamp</span><span class="p">[</span><span class="n">input_timestamp</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">files</span><span class="p">[</span><span class="n">index</span><span class="p">]][</span>
        <span class="s2">&quot;timestamp&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cur_timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">cur_timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
    <span class="n">next_timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">input_timestamp</span><span class="p">[</span>
        <span class="n">input_timestamp</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">files</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">next_timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
        <span class="n">next_timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">next_timestamp</span> <span class="o">-</span> <span class="n">cur_timestamp</span></div>

<div class="viewcode-block" id="to_timestamp"><a class="viewcode-back" href="../../../autoapi/OSmOSE/cluster/audio_reshaper/index.html#OSmOSE.cluster.audio_reshaper.to_timestamp">[docs]</a><span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span></div>

<span class="c1"># TODO: what to do with overlapping last file ? Del or incomplete ?</span>
<div class="viewcode-block" id="reshape"><a class="viewcode-back" href="../../../autoapi/OSmOSE/cluster/index.html#OSmOSE.cluster.audio_reshaper.reshape">[docs]</a><span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span>
    <span class="n">input_files</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output_dir_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_ind_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">batch_ind_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_delta_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">last_file_behavior</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;truncate&quot;</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;discard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
    <span class="n">offset_beginning</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">offset_end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">timestamp_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">force_reshape</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reshape all audio files in the folder to be of the specified duration. If chunk_size is superior to the base duration of the files, they will be fused according to their order in the timestamp.csv file in the same folder.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">        input_files: `str` or `list(str)`</span>
<span class="sd">            Either the directory containing the audio files and the timestamp.csv file, in which case all audio files will be considered,</span>
<span class="sd">            OR a list of audio files all located in the same directory alongside a timestamp.csv, in which case only they will be used.</span>

<span class="sd">        chunk_size: `int`</span>
<span class="sd">            The target duration for all the reshaped files, in seconds.</span>

<span class="sd">        output_dir_path: `str`, optional, keyword-only</span>
<span class="sd">            The directory where the newly created audio files will be created. If none is provided,</span>
<span class="sd">            it will be the same as the input directory. This is not recommended.</span>

<span class="sd">        batch_ind_min: `int`, optional, keyword-only</span>
<span class="sd">            The first file of the list to be processed. Default is 0.</span>

<span class="sd">        batch_ind_max: `int`, optional, keyword-only</span>
<span class="sd">            The last file of the list to be processed. Default is -1, meaning the entire list is processed.</span>

<span class="sd">        max_delta_interval: `int`, optional, keyword-only</span>
<span class="sd">            The maximum number of second allowed for a delta between two timestamp_list to still be considered the same.</span>
<span class="sd">            Default is 5s up and down.</span>

<span class="sd">        last_file_behavior: `{&quot;truncate&quot;,&quot;pad&quot;,&quot;discard&quot;}, optional, keyword-only</span>
<span class="sd">            Tells the reshaper what to do with if the last data of the last file is too small to fill a whole file.</span>
<span class="sd">            This parameter is only active if `batch_ind_max` is `-1`</span>
<span class="sd">            - `truncate` creates a truncated file with the remaining data, which will have a different duration than the others.</span>
<span class="sd">            - `pad` creates a file of the same duration than the others, where the missing data is filled with 0.</span>
<span class="sd">            - `discard` ignores the remaining data. The last seconds/minutes/hours of audio will be lost in the reshaping.</span>
<span class="sd">        The default methodd is `pad`.</span>

<span class="sd">        offset_beginning: `int`, optional, keyword-only</span>
<span class="sd">            The number of seconds that should be skipped in the first input file. When parallelising the reshaping,</span>
<span class="sd">            it would mean that the beginning of the file is being processed by another job. Default is 0.</span>

<span class="sd">        offset_end: `int`, optional, keyword-only</span>
<span class="sd">            The number of seconds that should be ignored in the last input file. When parallelising the reshaping, it would mean that the end of this file is processed by another job.</span>
<span class="sd">            Default is 0, meaning that nothing is ignored.</span>

<span class="sd">        verbose: `bool`, optional, keyword-only</span>
<span class="sd">            Whether to display informative messages or not.</span>

<span class="sd">        overwrite: `bool`, optional, keyword-only</span>
<span class="sd">            Deletes the content of `output_dir_path` before writing the results. If it is implicitly the `input_files` directory,</span>
<span class="sd">            nothing happens. WARNING: If `output_dir_path` is explicitly set to be the same as `input_files`, then it will be overwritten!</span>

<span class="sd">        force_reshape: `bool`, optional, keyword-only</span>
<span class="sd">            Ignore all warnings and non-fatal errors while reshaping.</span>

<span class="sd">        lock: `multiprocessing.lock`, optional, keyword-only</span>
<span class="sd">            An optional lock when the reshaping is done locally in parallel.</span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        The list of the path of newly created audio files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">set_umask</span><span class="p">()</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">input_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">input_files</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input directory detected as </span><span class="si">{</span><span class="n">input_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_files</span><span class="p">)</span>

    <span class="c1">#! Validation</span>
    <span class="k">if</span> <span class="n">last_file_behavior</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;truncate&quot;</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;discard&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Bad value </span><span class="si">{</span><span class="n">last_file_behavior</span><span class="si">}</span><span class="s2"> for last_file_behavior parameters. Must be one of truncate, pad or discard.&quot;</span>
        <span class="p">)</span>

    <span class="n">implicit_output</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir_path</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output directory provided. Will use the input directory instead.&quot;</span><span class="p">)</span>
        <span class="n">implicit_output</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">output_dir_path</span> <span class="o">=</span> <span class="n">input_dir_path</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Cannot overwrite input directory when the output directory is implicit! Choose a different output directory instead.&quot;</span>
            <span class="p">)</span>

    <span class="n">output_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_dir_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The input files must either be a valid folder path or a list of file path, not </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">input_dir_path</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">timestamp_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">timestamp_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The timestamp.csv file must be present in the directory </span><span class="si">{</span><span class="n">input_dir_path</span><span class="si">}</span><span class="s2"> and correspond to the audio files in the same location, or be specified in the argument.&quot;</span>
        <span class="p">)</span>

    <span class="n">make_path</span><span class="p">(</span><span class="n">output_dir_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">DPDEFAULT</span><span class="p">)</span>

    <span class="n">input_timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">timestamp_path</span> <span class="k">if</span> <span class="n">timestamp_path</span> <span class="ow">and</span> <span class="n">timestamp_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">),</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;timezone&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># When automatically reshaping, will populate the files list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">input_timestamp</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">][</span>
                <span class="n">batch_ind_min</span> <span class="p">:</span> <span class="n">batch_ind_max</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">batch_ind_max</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">input_timestamp</span><span class="o">.</span><span class="n">size</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Files to be reshaped: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">timestamp_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">.</span><span class="n">duration</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">batch_ind_min</span><span class="p">)</span>
        <span class="o">/</span> <span class="n">chunk_size</span>
    <span class="p">)</span>
    <span class="n">proceed</span> <span class="o">=</span> <span class="n">force_reshape</span>  <span class="c1"># Default is False</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">audio_data</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">file_duration</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span><span class="o">//</span><span class="n">sample_rate</span>
        
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">implicit_output</span> <span class="ow">and</span> <span class="n">output_dir_path</span> <span class="o">==</span> <span class="n">input_dir_path</span> <span class="ow">and</span> <span class="n">output_dir_path</span> <span class="o">==</span> <span class="n">input_dir_path</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">input_timestamp</span><span class="p">[</span><span class="n">input_timestamp</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span>
                <span class="s2">&quot;timestamp&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">offset_beginning</span><span class="p">)</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">audio_data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">offset_beginning</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">offset_end</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_file_behavior</span> <span class="o">==</span> <span class="s2">&quot;pad&quot;</span>
        <span class="p">):</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">audio_data</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset_end</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">previous_audio_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">input_timestamp</span><span class="p">[</span><span class="n">input_timestamp</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span>
                <span class="s2">&quot;timestamp&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Need to check if size &gt; 1 because numpy arrays are never empty urgh</span>
        <span class="k">if</span> <span class="n">previous_audio_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">previous_audio_data</span><span class="p">,</span> <span class="n">audio_data</span><span class="p">))</span>
            <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#! AUDIO DURATION &gt; CHUNK SIZE</span>
        <span class="c1"># While the duration of the audio is longer than the target chunk, we segment it into small files</span>
        <span class="c1"># This means to account for the creation of 10s long files from big one and not overload audio_data.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">audio_data</span><span class="p">[:</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">]</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">audio_data</span><span class="p">[</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="p">:]</span>

                <span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span>
                    <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">t</span> <span class="o">*</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">//</span> <span class="n">sample_rate</span>
                <span class="p">)</span>

                <span class="n">outfilename</span> <span class="o">=</span> <span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.wav&quot;</span>
                <span class="p">)</span>

                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfilename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
                <span class="p">)</span>
                <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

                <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">outfilename</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;WAV&quot;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;DOUBLE&quot;</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s2"> written! File is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds long. </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds left from slicing.&quot;</span>
                    <span class="p">)</span>

                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">audio_data</span> <span class="o">=</span> <span class="n">previous_audio_data</span>

            <span class="c1"># If after we get out of the previous while loop we don&#39;t have any audio_data left, then we look at the next file.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="c1">#! AUDIO DURATION == CHUNK SIZE</span>
        <span class="c1"># Else if audio_data is already in the desired duration, output it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">audio_data</span>
            <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#! AUDIO DURATION &lt; CHUNK_SIZE</span>
        <span class="c1"># Else it is shorter, then while the duration is shorter than the desired chunk,</span>
        <span class="c1"># we read the next file and append it to the current one.</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">:</span>
            <span class="c1"># If it is the last file but the audio_data is shorter than the desired chunk, then fill the remaining space with silence.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">audio_data</span>
                <span class="k">break</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">))</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">audio_data</span><span class="p">,</span> <span class="n">fill</span><span class="p">))</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if the timestamp_list can safely be merged</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">file_duration</span> <span class="o">-</span> <span class="n">max_delta_interval</span>
                    <span class="o">&lt;</span> <span class="n">substract_timestamps</span><span class="p">(</span><span class="n">input_timestamp</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
                    <span class="o">&lt;</span> <span class="n">file_duration</span> <span class="o">+</span> <span class="n">max_delta_interval</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: You are trying to merge two audio files that are not chronologically consecutive.</span><span class="se">\n</span><span class="si">{</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> ends at </span><span class="si">{</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">input_timestamp</span><span class="p">[</span><span class="n">input_timestamp</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">file_duration</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> starts at </span><span class="si">{</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">input_timestamp</span><span class="p">[</span><span class="n">input_timestamp</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">proceed</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
                    <span class="p">):</span>  <span class="c1"># check if the script runs in an interactive shell. Otherwise will fail if proceed = False</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                            <span class="s2">&quot;If you proceed, some timestamps will be lost in the reshaping. Proceed anyway? This message won&#39;t show up again if you choose to proceed. ([yes]/no)&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">res</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">proceed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">proceed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;Error: Cannot merge non-continuous audio files if force_reshape is false.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                    <span class="n">nextdata</span><span class="p">,</span> <span class="n">next_sample_rate</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                        <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">implicit_output</span> <span class="ow">and</span> <span class="n">output_dir_path</span> <span class="o">==</span> <span class="n">input_dir_path</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="n">rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">next_sample_rate</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_data</span><span class="p">)</span>
                    <span class="n">audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">audio_data</span><span class="p">,</span>
                            <span class="n">nextdata</span><span class="p">[:</span><span class="n">rest</span><span class="p">]</span> <span class="k">if</span> <span class="n">rest</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nextdata</span><span class="p">)</span> <span class="k">else</span> <span class="n">nextdata</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">audio_data</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">nextdata</span><span class="p">[</span><span class="n">rest</span><span class="p">:]</span>

        <span class="n">outfilename</span> <span class="o">=</span> <span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.wav&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfilename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
        <span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;WAV&quot;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;DOUBLE&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s2"> written! File is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds long. </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds left from slicing.&quot;</span>
            <span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">#! AFTER MAIN LOOP</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">previous_audio_data</span><span class="p">[:</span> <span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">]</span>
        <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">previous_audio_data</span><span class="p">[</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="p">:]</span>

        <span class="n">outfilename</span> <span class="o">=</span> <span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.wav&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfilename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
        <span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;WAV&quot;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;DOUBLE&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s2"> written! File is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds long. </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds left from slicing.&quot;</span>
            <span class="p">)</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">skip_last</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">match</span> <span class="n">last_file_behavior</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;truncate&quot;</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">previous_audio_data</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">chunk_size</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">))</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">previous_audio_data</span><span class="p">,</span> <span class="n">fill</span><span class="p">))</span>
                <span class="n">previous_audio_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">case</span> <span class="s2">&quot;discard&quot;</span><span class="p">:</span>
                <span class="n">skip_last</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_last</span><span class="p">:</span>

            <span class="n">outfilename</span> <span class="o">=</span> <span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.wav&quot;</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfilename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

            <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;WAV&quot;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s2">&quot;DOUBLE&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">outfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s2"> written! File is </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)</span><span class="si">}</span><span class="s2"> seconds long. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_audio_data</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span><span class="si">}</span><span class="s2"> seconds left from slicing.&quot;</span>
                <span class="p">)</span>

    <span class="k">for</span> <span class="n">remaining_file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()]:</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">implicit_output</span> <span class="ow">and</span> <span class="n">output_dir_path</span> <span class="o">==</span> <span class="n">input_dir_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="n">remaining_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">input_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">remaining_file</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="n">path_csv</span> <span class="o">=</span> <span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;timestamp.csv&quot;</span><span class="p">)</span>

    <span class="n">lock</span> <span class="o">=</span> <span class="n">FileLock</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_csv</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="c1"># suppr doublons</span>
        <span class="k">if</span> <span class="n">path_csv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">tmp_timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_csv</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_timestamp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">timestamp_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_timestamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">input_timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp_list</span><span class="p">,</span> <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">input_timestamp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">input_timestamp</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">path_csv</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">na_rep</span><span class="o">=</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path_csv</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">FPDEFAULT</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">output_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;required arguments&quot;</span><span class="p">)</span>
    <span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--input-files&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The files to be reshaped, as either the path to a directory containing audio files and a timestamp.csv or a list of filenames all in the same directory alongside a timestamp.csv.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">required</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--chunk-size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The time in seconds of the reshaped files.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output-dir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path to the directory to write reshaped files. Default is same as --input-files directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--batch-ind-min&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-min&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The first file of the list to be processed. Default is 0.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--batch-ind-max&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-max&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The last file of the list to be processed. Default is -1, meaning the entire list is processed.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--offset-beginning&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;number of seconds that should be skipped in the first input file. When parallelising the reshaping, it would mean that the beginning of the file is being processed by another job. Default is 0.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--offset-end&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of seconds that should be ignored in the last input file. When parallelising the reshaping, it would mean that the end of this file is processed by another job. Default is 0, meaning that nothing is ignored.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--max-delta-interval&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The maximum number of second allowed for a delta between two timestamp_list to still be considered the same. Default is 5s up and down.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether the script prints informative messages. Default is true.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, deletes all content in --output-dir before writing the output. Default false, deactivated if the --output-dir is the same as --input-file dir.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ignore all warnings and non-fatal errors while reshaping.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--last-file-behavior&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tells the program what to do with the remaining data that are shorter than the chunk size. Possible arguments are pad (the default), which pads with silence until the last file has the same length as the others; truncate to create a shorter file with only the leftover data; discard to not do anything with the last data and throw it away.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--timestamp-path&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the original timestamp file.&quot;</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">input_files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_files</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_files</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
        <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">input_files</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters :&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span>
        <span class="n">input_files</span><span class="o">=</span><span class="n">input_files</span><span class="p">,</span>
        <span class="n">output_dir_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">batch_ind_min</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_ind_min</span><span class="p">,</span>
        <span class="n">batch_ind_max</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_ind_max</span><span class="p">,</span>
        <span class="n">offset_beginning</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">offset_beginning</span><span class="p">,</span>
        <span class="n">offset_end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">offset_end</span><span class="p">,</span>
        <span class="n">timestamp_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">timestamp_path</span><span class="p">),</span>
        <span class="n">max_delta_interval</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_delta_interval</span><span class="p">,</span>
        <span class="n">last_file_behavior</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">last_file_behavior</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="n">force_reshape</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> reshaped audio files written in </span><span class="si">{</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Rumengol.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>